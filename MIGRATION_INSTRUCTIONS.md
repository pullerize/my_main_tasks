# Инструкция по применению миграции базы данных

## Проблема
Telegram бот выдает ошибку при попытке сохранить расход:
```
❌ Не удалось сохранить расход. Попробуйте позже.
```

## Причина
В таблице `employee_expenses` отсутствует поле `project_id`, которое используется ботом.

## Решение
Необходимо применить миграцию для добавления поля `project_id` в таблицу `employee_expenses`.

## Шаги для применения миграции на production сервере

### 1. Подключитесь к серверу
```bash
ssh root@185.207.64.109
```

### 2. Перейдите в директорию проекта
```bash
cd /opt/8bit-codex
```

### 3. Получите последние изменения
```bash
git pull
```

### 4. Примените миграцию
```bash
python3 migrate_add_project_id.py
```

Вы должны увидеть:
```
✅ Поле project_id успешно добавлено! (SQLite/PostgreSQL)
✅ Миграция завершена!
```

Или, если миграция уже применена:
```
✅ Поле project_id уже существует в таблице employee_expenses
✅ Миграция завершена!
```

### 5. Перезапустите Telegram бота

**Если бот запущен в Docker:**
```bash
docker-compose down telegram_bot
docker rmi -f 8bit-codex-telegram_bot
docker-compose up -d telegram_bot
```

**Если бот запущен напрямую:**
```bash
# Найдите процесс бота
ps aux | grep bot.py

# Убейте процесс (замените PID на нужный)
kill <PID>

# Запустите бота заново
cd telegram_bot
python3 bot.py &
```

### 6. Проверьте работу бота
Попробуйте создать расход через бота - теперь он должен сохраняться успешно.

## Примечания
- Миграция безопасна и не удаляет существующие данные
- Скрипт автоматически определяет тип базы данных (SQLite или PostgreSQL)
- Скрипт можно запускать повторно - он проверяет наличие поля перед добавлением

## Откат миграции (если потребуется)

**SQLite:**
```sql
-- Откат невозможен в SQLite без пересоздания таблицы
-- Рекомендуется сделать резервную копию перед миграцией
```

**PostgreSQL:**
```sql
ALTER TABLE employee_expenses DROP COLUMN project_id;
```
